<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Water Distribution Management - Flow System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;display:flex;height:100vh;overflow:hidden}.map-container{flex:1;position:relative}#map{width:100%;height:100%}.map-controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;gap:8px;background:#fff;padding:8px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2)}.map-controls button{padding:10px 16px;border:none;background:#f8f9fa;cursor:pointer;border-radius:4px;font-size:14px;transition:all .2s}.map-controls button:hover{background:#e9ecef}.map-controls button.active{background:#1a73e8;color:#fff}.settings-btn{position:absolute;left:20px;z-index:1000;background:#fff;border:none;padding:12px;border-radius:50%;box-shadow:0 2px 10px rgba(0,0,0,.15);cursor:pointer;transition:all .2s;width:48px;height:48px;display:flex;align-items:center;justify-content:center}.settings-btn:hover{box-shadow:0 4px 15px rgba(0,0,0,.25);transform:scale(1.05)}.settings-btn svg{width:24px;height:24px}#deviceSettingsBtn{top:20px}#gateWallSettingsBtn{top:80px}#searchBtn{top:140px}#quickSearchBtn{top:200px}.flow-legend{position:absolute;bottom:80px;left:20px;z-index:1000;background:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);font-size:12px}.flow-legend-item{display:flex;align-items:center;gap:8px;margin-bottom:6px}.flow-legend-item:last-child{margin-bottom:0}.flow-line{width:30px;height:4px;border-radius:2px}.flow-line.active{background:#2196F3}.flow-line.inactive{background:#F44336}.top-panel{position:absolute;top:20px;right:20px;z-index:1000;width:320px;max-height:calc(100vh - 40px);overflow-y:auto;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15)}.search-hierarchy{padding:15px}.hierarchy-level{margin-bottom:12px}.hierarchy-level label{display:block;font-size:11px;font-weight:600;color:#666;margin-bottom:4px;text-transform:uppercase}.hierarchy-level input,.hierarchy-level select{width:100%;padding:8px 10px;border:2px solid #e0e0e0;border-radius:6px;font-size:13px;transition:border .2s}.hierarchy-level input:focus,.hierarchy-level select:focus{outline:0;border-color:#1a73e8}.search-results{padding:10px 15px;border-top:1px solid #e0e0e0}.results-header{font-size:12px;font-weight:600;color:#333;margin-bottom:8px}.result-item{padding:8px 10px;margin-bottom:4px;background:#f8f9fa;border-radius:4px;cursor:pointer;transition:all .2s;font-size:12px;border-left:3px solid transparent}.result-item:hover{background:#e9ecef;border-left-color:#1a73e8;transform:translateX(2px)}.result-item .item-type{display:inline-block;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:600;margin-right:6px}.type-ohsr{background:#2196f3;color:#fff}.type-gateway{background:#4caf50;color:#fff}.type-gatewall{background:#9c27b0;color:#fff}.type-pipeline{background:#ff5722;color:#fff}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;backdrop-filter:blur(4px)}.modal.active{display:flex;align-items:center;justify-content:center}.modal-content{background:#fff;border-radius:12px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,.3);animation:modalSlide .3s ease}@keyframes modalSlide{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}.modal-header{padding:20px 24px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}.modal-header h2{font-size:18px;color:#333;margin:0}.close-btn{background:0 0;border:none;font-size:28px;color:#666;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .2s}.close-btn:hover{background:#f0f0f0;color:#333}.modal-body{padding:24px}.tab-buttons{display:flex;gap:8px;margin-bottom:20px;border-bottom:2px solid #e0e0e0}.tab-btn{padding:10px 16px;background:0 0;border:none;cursor:pointer;font-size:13px;font-weight:500;color:#666;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}.tab-btn:hover{color:#333}.tab-btn.active{color:#1a73e8;border-bottom-color:#1a73e8}.tab-content{display:none}.tab-content.active{display:block}.form-group{margin-bottom:14px}.form-group label{display:block;font-size:12px;font-weight:600;margin-bottom:5px;color:#333}.form-group input,.form-group select{width:100%;padding:9px 11px;border:2px solid #e0e0e0;border-radius:6px;font-size:13px;transition:border .2s}.form-group input:focus,.form-group select:focus{outline:0;border-color:#1a73e8}.btn{width:100%;padding:11px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;margin-top:6px}.btn-primary{background:#1a73e8;color:#fff}.btn-primary:hover{background:#1557b0}.btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}.btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}.btn-secondary{background:#6c757d;color:#fff}.btn-secondary:hover{background:#5a6268}.info-text{font-size:11px;color:#666;margin-top:8px;padding:8px;background:#f8f9fa;border-radius:4px;line-height:1.5}.drawing-indicator{position:absolute;top:80px;left:50%;transform:translateX(-50%);z-index:1000;background:#28a745;color:#fff;padding:10px 20px;border-radius:6px;font-size:13px;font-weight:600;box-shadow:0 2px 10px rgba(0,0,0,.2);display:none;animation:pulse 1.5s infinite}.drawing-indicator.active{display:block}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}.side-panel{position:fixed;right:-500px;top:0;width:500px;height:100vh;background:#fff;box-shadow:-5px 0 20px rgba(0,0,0,.3);transition:right .3s ease;z-index:2000;overflow-y:auto}.side-panel.active{right:0}.panel-header{padding:20px;background:linear-gradient(135deg,#1a73e8 0,#1557b0 100%);color:#fff;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}.panel-header.gatewall{background:linear-gradient(135deg,#9c27b0 0,#7b1fa2 100%)}.panel-header.pipeline{background:linear-gradient(135deg,#FF5722 0,#E64A19 100%)}.panel-header h2{margin:0;font-size:17px;font-weight:600}.panel-close-btn{background:rgba(255,255,255,.2);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all .2s}.panel-close-btn:hover{background:rgba(255,255,255,.3);transform:scale(1.1)}.panel-section{padding:18px;border-bottom:1px solid #e0e0e0}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.section-header h3{margin:0;font-size:15px;color:#333}.detail-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #f0f0f0}.detail-row:last-child{border-bottom:none}.detail-label{font-size:12px;color:#666;font-weight:500}.detail-value{font-size:12px;color:#333;font-weight:600}.status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600}.status-active{background:#d4edda;color:#155724}.status-inactive{background:#f8d7da;color:#721c24}.flow-controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}.flow-btn{padding:10px 14px;border:2px solid #e0e0e0;background:#fff;border-radius:6px;cursor:pointer;transition:all .2s;font-size:13px;min-width:130px}.flow-btn:hover{background:#f0f0f0;border-color:#1a73e8}.flow-btn.active{background:#1a73e8;color:#fff;border-color:#1a73e8}.flow-segment{margin-bottom:10px;padding:10px;background:#f8f9fa;border-radius:6px;border-left:4px solid #e0e0e0}.flow-segment.flowing{border-left-color:#2196F3}.flow-segment.blocked{border-left-color:#F44336}.notification{position:fixed;top:20px;right:20px;padding:12px 20px;background:#1a73e8;color:#fff;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:10000;font-size:13px;font-weight:500;animation:slideIn .3s ease}@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}.notification.success{background:#28a745}.notification.error{background:#dc3545}.notification.warning{background:#ffc107;color:#333}.notification.info{background:#17a2b8}.history-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px}.history-table th{background:#f8f9fa;padding:8px;text-align:left;border-bottom:2px solid #dee2e6;font-weight:600;position:sticky;top:0}.history-table td{padding:8px;border-bottom:1px solid #e9ecef}.history-filters{display:flex;gap:8px;margin-bottom:10px}.history-filters input{flex:1;padding:6px;border:1px solid #e0e0e0;border-radius:4px;font-size:11px}.action-btns{display:flex;gap:6px;margin-top:10px}.action-btns button{flex:1;padding:8px;font-size:11px}
    </style>
</head>
<body>
    <div class="map-container">
        <div id="map"></div>
        
        <button class="settings-btn" id="deviceSettingsBtn" title="Device Settings">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
            </svg>
        </button>

        <button class="settings-btn" id="gateWallSettingsBtn" title="Gate Wall Settings">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
        </button>

        <button class="settings-btn" id="searchBtn" title="Hierarchical Search">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
        </button>

        <button class="settings-btn" id="quickSearchBtn" title="Quick Device Search">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
            </svg>
        </button>

        <button class="settings-btn" id="locationSearchBtn" title="Search Location" style="top:260px;">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        </button>

        <div class="flow-legend">
            <div style="font-weight:600;margin-bottom:8px;font-size:13px;">üíß Flow Status</div>
            <div class="flow-legend-item">
                <div class="flow-line active"></div>
                <span>Water Flowing</span>
            </div>
            <div class="flow-legend-item">
                <div class="flow-line inactive"></div>
                <span>No Flow / Blocked</span>
            </div>
        </div>

        <div class="top-panel" id="locationSearchPanel" style="display:none;">
            <div class="search-hierarchy">
                <h3 style="margin-bottom:15px;font-size:15px;color:#333;">üîç Search Location</h3>
                
                <div class="hierarchy-level">
                    <label>Enter City, Area or Landmark (Live Search)</label>
                    <input type="text" id="locationSearchInput" placeholder="Type to search... (e.g., Hanamkonda, Warangal)" 
                        style="border-color:#1a73e8;">
                    <div style="font-size:10px;color:#666;margin-top:4px;">
                        üí° Results appear as you type. Works with any keyword!
                    </div>
                </div>
                
                <div id="locationResults" style="margin-top:15px;display:none;">
                    <div style="font-size:12px;font-weight:600;color:#666;margin-bottom:8px;">Results:</div>
                    <div id="locationResultsList"></div>
                </div>
            </div>
        </div>

        <div class="drawing-indicator" id="drawingIndicator">
            üé® Drawing Mode - Click to add points ‚Ä¢ Double-click to finish
        </div>

        <div class="top-panel" id="hierarchyPanel" style="display:none;">
            <div class="search-hierarchy">
                <h3 style="margin-bottom:15px;font-size:15px;color:#333;">üó∫Ô∏è Region Search</h3>
                
                <div class="hierarchy-level">
                    <label>Country</label>
                    <select id="searchCountry">
                        <option value="">Select Country</option>
                    </select>
                </div>

                <div class="hierarchy-level">
                    <label>State</label>
                    <select id="searchState" disabled>
                        <option value="">Select State</option>
                    </select>
                </div>

                <div class="hierarchy-level">
                    <label>District</label>
                    <select id="searchDistrict" disabled>
                        <option value="">Select District</option>
                    </select>
                </div>

                <div class="hierarchy-level">
                    <label>Mandal</label>
                    <select id="searchMandal" disabled>
                        <option value="">Select Mandal</option>
                    </select>
                </div>

                <div class="hierarchy-level">
                    <label>Habitation</label>
                    <select id="searchHabitation" disabled>
                        <option value="">Select Habitation</option>
                    </select>
                </div>
            </div>

            <div class="search-results" id="hierarchyResults" style="display:none;">
                <div class="results-header">Devices in Region</div>
                <div id="hierarchyResultsList"></div>
            </div>
        </div>

        <div class="top-panel" id="quickSearchPanel" style="display:none;">
            <div class="search-hierarchy">
                <h3 style="margin-bottom:15px;font-size:15px;color:#333;">üîç Quick Device Search</h3>
                
                <div class="hierarchy-level">
                    <label>Search by Name or ID</label>
                    <input type="text" id="quickSearchInput" placeholder="Type device name or ID...">
                </div>
            </div>

            <div class="search-results" id="quickResults" style="display:none;">
                <div class="results-header">Search Results</div>
                <div id="quickResultsList"></div>
            </div>
        </div>

        <div class="map-controls">
            <button onclick="changeMapLayer('satellite')" class="active" id="btn-satellite">Satellite</button>
            <button onclick="changeMapLayer('street')" id="btn-street">Street</button>
            <button onclick="changeMapLayer('terrain')" id="btn-terrain">Terrain</button>
        </div>
    </div>

    <!-- Device Modal -->
    <div class="modal" id="deviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè≠ Device Management</h2>
                <button class="close-btn" onclick="closeModal('deviceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('device','add')">Add Device</button>
                    <button class="tab-btn" onclick="switchTab('device','list')">Device List</button>
                    <button class="tab-btn" onclick="switchTab('device','data')">Import/Export</button>
                </div>

                <div class="tab-content active" id="device-add-tab">
                    <div class="form-group">
                        <label>Device Name *</label>
                        <input type="text" id="deviceName" placeholder="e.g., OHSR Tank 1">
                    </div>
                    <div class="form-group">
                        <label>Device Type *</label>
                        <select id="deviceType">
                            <option value="ohsr">OHSR Tank</option>
                            <option value="gateway">Gateway</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <select id="deviceCountry">
                            <option value="India">India</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="deviceState" placeholder="e.g., Telangana" list="statesList">
                        <datalist id="statesList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>District</label>
                        <input type="text" id="deviceDistrict" placeholder="e.g., Warangal" list="districtsList">
                        <datalist id="districtsList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>Mandal</label>
                        <input type="text" id="deviceMandal" placeholder="e.g., Warangal Urban" list="mandalsList">
                        <datalist id="mandalsList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>Habitation</label>
                        <input type="text" id="deviceHabitation" placeholder="e.g., Hanamkonda" list="habitationsList">
                        <datalist id="habitationsList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>Latitude *</label>
                        <input type="number" id="deviceLat" step="0.000001" placeholder="17.385000">
                    </div>
                    <div class="form-group">
                        <label>Longitude *</label>
                        <input type="number" id="deviceLng" step="0.000001" placeholder="78.486000">
                    </div>
                    <div class="form-group">
                        <label>Capacity (Liters)</label>
                        <input type="number" id="deviceCapacity" placeholder="1000">
                    </div>
                    <button class="btn btn-primary" onclick="addDevice()">‚úì Add Device</button>
                    <div class="info-text">üí° Right-click on map to auto-fill coordinates</div>
                </div>

                <div class="tab-content" id="device-list-tab">
                    <div id="deviceListContainer" style="max-height:400px;overflow-y:auto;"></div>
                </div>

                <div class="tab-content" id="device-data-tab">
                    <button class="btn btn-success" onclick="exportAllData()">üì• Export All Data</button>
                    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Import Data</button>
                    <button class="btn btn-primary" onclick="generateDummyData()">üé≤ Generate Dummy Data</button>
                    <div class="info-text">Export/import all devices, gate walls, and pipelines to JSON</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gate Wall Modal -->
    <div class="modal" id="gateWallModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üöß Gate Wall Management</h2>
                <button class="close-btn" onclick="closeModal('gateWallModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('gatewall','add')">Add Gate Wall</button>
                    <button class="tab-btn" onclick="switchTab('gatewall','pipeline')">Draw Pipeline</button>
                    <button class="tab-btn" onclick="switchTab('gatewall','list')">Gate Wall List</button>
                </div>

                <div class="tab-content active" id="gatewall-add-tab">
                    <div class="form-group">
                        <label>Gate Wall Name *</label>
                        <input type="text" id="gwName" placeholder="e.g., Main Gate 1">
                    </div>
                    <div class="form-group">
                        <label>Gate Wall Type *</label>
                        <select id="gwType">
                            <option value="straight">Straight Flow</option>
                            <option value="t-junction">T-Junction (3-way)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <select id="gwCountry">
                            <option value="India">India</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="gwState" placeholder="e.g., Telangana" list="statesList">
                    </div>
                    <div class="form-group">
                        <label>District</label>
                        <input type="text" id="gwDistrict" placeholder="e.g., Warangal" list="districtsList">
                    </div>
                    <div class="form-group">
                        <label>Mandal</label>
                        <input type="text" id="gwMandal" placeholder="e.g., Warangal Urban" list="mandalsList">
                    </div>
                    <div class="form-group">
                        <label>Habitation</label>
                        <input type="text" id="gwHabitation" placeholder="e.g., Hanamkonda" list="habitationsList">
                    </div>
                    <div class="form-group">
                        <label>Latitude *</label>
                        <input type="number" id="gwLat" step="0.000001" placeholder="17.385000">
                    </div>
                    <div class="form-group">
                        <label>Longitude *</label>
                        <input type="number" id="gwLng" step="0.000001" placeholder="78.486000">
                    </div>
                    <button class="btn btn-primary" onclick="addGateWall()">‚úì Add Gate Wall</button>
                    <div class="info-text">üí° Right-click on map to auto-fill coordinates</div>
                </div>

                <div class="tab-content" id="gatewall-pipeline-tab">
                    <button class="btn btn-success" id="drawPipelineBtn" onclick="toggleDrawPipeline()">
                        üé® Start Drawing Pipeline
                    </button>
                    <div class="info-text">
                        <b>How to draw pipelines:</b><br>
                        ‚Ä¢ Click "Start Drawing" to begin<br>
                        ‚Ä¢ Click on map to add points<br>
                        ‚Ä¢ Double-click to finish<br>
                        ‚Ä¢ Click near devices/gate walls to connect<br>
                        <br>
                        <b>üíß Flow Control System:</b><br>
                        ‚ö†Ô∏è <b>Pipelines DON'T auto-update!</b><br>
                        ‚Ä¢ Default: All pipelines BLUE (flowing)<br>
                        ‚Ä¢ To stop flow: Click gate ‚Üí "‚õî Stop Flow"<br>
                        ‚Ä¢ Downstream turns RED immediately<br>
                        ‚Ä¢ To restore: Click gate ‚Üí "‚û°Ô∏è Flow On"<br>
                        ‚Ä¢ Entire pipeline turns BLUE<br>
                        <br>
                        <b>‚ú® Manual Control Only:</b><br>
                        Colors change ONLY when YOU control gates!
                    </div>
                </div>

                <div class="tab-content" id="gatewall-list-tab">
                    <div id="gateWallListContainer" style="max-height:400px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Side Panel -->
    <div class="side-panel" id="detailsPanel">
        <div class="panel-header" id="panelHeader">
            <h2 id="panelTitle">Details</h2>
            <button class="panel-close-btn" onclick="closeDetailsPanel()">&times;</button>
        </div>
        <div id="panelContent"></div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width:900px;">
            <div class="modal-header">
                <h2 id="historyModalTitle">üìä Device History</h2>
                <button class="close-btn" onclick="closeModal('historyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="history-filters">
                    <input type="date" id="historyStartDate" placeholder="Start Date">
                    <input type="date" id="historyEndDate" placeholder="End Date">
                    <button class="btn btn-primary" onclick="filterHistory()" style="width:auto;padding:6px 12px;">Filter</button>
                    <button class="btn btn-secondary" onclick="exportHistoryCSV()" style="width:auto;padding:6px 12px;">üì• Export CSV</button>
                </div>
                <div style="max-height:500px;overflow-y:auto;">
                    <table class="history-table" id="historyTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Water Level</th>
                                <th>Pressure</th>
                                <th>Flow Rate</th>
                                <th>pH Level</th>
                                <th>Temperature</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="GateWallDynamicManager.js"></script>
    <script src="GateWallStaticManager.js"></script>
    <script src="TankDynamicManager.js"></script>
    <script src="TankStaticManager.js"></script>
    <script src="PipelineStaticManager.js"></script>
    <script src="PipelineDynamicManager.js"></script>
    <script>
// COMPRESSED IoT WATER MANAGEMENT SYSTEM - Main App Logic
const App = {
    map: null, currentLayer: null, markers: {}, polylines: {}, drawingMode: false,
    currentPipeline: [], lastClickTime: 0, currentDevice: null, historyData: [],
    editingDevice: null, tempLocationMarker: null, hierarchy: {}, tempPolyline: null,

    init() {
        [TankStaticManager, TankDynamicManager, GateWallStaticManager, 
         GateWallDynamicManager, PipelineStaticManager, PipelineDynamicManager].forEach(m => m.init());
        this.initMap();
        this.setupEventListeners();
        this.loadData();
        this.startSimulation();
    },

    initMap() {
        this.map = L.map('map').setView([17.385, 78.486], 13);
        this.layers = {
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
            street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png')
        };
        this.currentLayer = this.layers.satellite.addTo(this.map);
        this.map.on('click', e => this.onMapClick(e));
        this.map.on('contextmenu', e => this.onMapRightClick(e));
    },

    setupEventListeners() {
        const els = {
            deviceSettingsBtn: () => this.openModal('deviceModal'),
            gateWallSettingsBtn: () => this.openModal('gateWallModal'),
            searchBtn: () => this.togglePanel('hierarchyPanel'),
            quickSearchBtn: () => this.togglePanel('quickSearchPanel'),
            locationSearchBtn: () => this.togglePanel('locationSearchPanel')
        };
        Object.entries(els).forEach(([id, fn]) => document.getElementById(id).onclick = fn);

        ['searchCountry', 'searchState', 'searchDistrict', 'searchMandal', 'searchHabitation']
            .forEach((id, i) => document.getElementById(id).onchange = e => 
                this.onHierarchyChange(['country','state','district','mandal','habitation'][i], e.target.value));

        document.getElementById('quickSearchInput').oninput = e => this.onQuickSearch(e.target.value);
        document.querySelectorAll('.modal').forEach(m => m.onclick = e => 
            e.target === m && this.closeModal(m.id));
    },

    loadData() {
        TankStaticManager.getAll().forEach(t => this.addDeviceMarker(t));
        GateWallStaticManager.getAll().forEach(g => this.addGateWallMarker(g));
        PipelineStaticManager.getAll().forEach(p => this.addPipelinePolyline(p));
        this.buildHierarchy();
        this.updateDatalistSuggestions();
        this.updateAllPipelineFlow();
    },

    addDeviceMarker(device) {
        const cfg = {ohsr: {emoji: 'üíß', color: '#2196F3'}, gateway: {emoji: 'üè≠', color: '#4CAF50'}}[device.type] || {emoji: 'üíß', color: '#2196F3'};
        const icon = L.divIcon({
            html: `<div style="background:${cfg.color};width:40px;height:40px;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 10px rgba(0,0,0,0.4);font-size:20px;cursor:pointer;">${cfg.emoji}</div>`,
            iconSize: [40, 40], className: 'custom-marker'
        });
        const marker = L.marker([device.latitude, device.longitude], {icon})
            .addTo(this.map).bindPopup(this.createDevicePopup(device));
        marker.on('click', e => {
            if(this.drawingMode) { e.originalEvent.stopPropagation(); return; }
            this.showDeviceDetails(device.id);
        });
        this.markers[device.id] = marker;
    },

    addGateWallMarker(gw) {
        const cfg = {straight: {emoji: 'üö™', color: '#9C27B0', shape: '50%'}, 
                     't-junction': {emoji: '‚öôÔ∏è', color: '#FF5722', shape: '10px'}}[gw.type] || {emoji: 'üö™', color: '#9C27B0', shape: '50%'};
        const icon = L.divIcon({
            html: `<div style="background:${cfg.color};width:40px;height:40px;border-radius:${cfg.shape};border:3px solid white;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 10px rgba(0,0,0,0.4);font-size:20px;cursor:pointer;">${cfg.emoji}</div>`,
            iconSize: [40, 40], className: 'custom-marker'
        });
        const marker = L.marker([gw.latitude, gw.longitude], {icon})
            .addTo(this.map).bindPopup(this.createGateWallPopup(gw));
        marker.on('click', e => {
            if(this.drawingMode) { e.originalEvent.stopPropagation(); return; }
            this.showGateWallDetails(gw.id);
        });
        this.markers[gw.id] = marker;
    },

    addPipelinePolyline(pipeline) {
        if(!pipeline.points || pipeline.points.length < 2) return;
        const dynamic = PipelineDynamicManager.getCurrent(pipeline.id);
        this.renderPipelineSegments(pipeline, dynamic);
    },

    renderPipelineSegments(pipeline, dynamic) {
        if(this.polylines[pipeline.id]) 
            this.polylines[pipeline.id].forEach(p => this.map.removeLayer(p));

        const segments = dynamic?.flowSegments || [{start: 0, end: 1, hasFlow: false}];
        const polylines = [];

        segments.forEach((seg, idx) => {
            const startIdx = Math.floor(seg.start * (pipeline.points.length - 1));
            const endIdx = Math.ceil(seg.end * (pipeline.points.length - 1));
            const segPts = pipeline.points.slice(startIdx, endIdx + 1);
            if(segPts.length < 2) return;

            const poly = L.polyline(segPts, {
                color: seg.hasFlow ? '#2196F3' : '#F44336', weight: 6, opacity: 0.8,
                lineJoin: 'round', lineCap: 'round'
            }).addTo(this.map);
            
            poly.on('click', e => {
                if(this.drawingMode) { e.originalEvent.stopPropagation(); return; }
            });

            if(seg.hasFlow && segPts.length >= 2) {
                const mid = Math.floor(segPts.length / 2);
                if(mid < segPts.length - 1) {
                    const angle = Math.atan2(segPts[mid + 1][0] - segPts[mid][0], 
                                            segPts[mid + 1][1] - segPts[mid][1]) * 180 / Math.PI;
                    polylines.push(L.marker(segPts[mid], {
                        icon: L.divIcon({
                            html: `<div style="transform:rotate(${angle}deg);font-size:20px;text-shadow:0 0 3px white;">‚û§</div>`,
                            iconSize: [20, 20], className: 'flow-arrow'
                        }), interactive: false
                    }).addTo(this.map));
                }
            }

            if(idx === 0) {
                poly.bindPopup(this.createPipelinePopup(pipeline, dynamic));
                poly.on('click', e => {
                    if(this.drawingMode) { e.originalEvent.stopPropagation(); return; }
                    this.showPipelineDetails(pipeline.id);
                });
            }
            polylines.push(poly);
        });
        this.polylines[pipeline.id] = polylines;
    },

    createDevicePopup(device) {
        const dyn = TankDynamicManager.getCurrent(device.id);
        return `<div style="min-width:220px;"><b>${device.name}</b><br><small>Type: ${device.type.toUpperCase()}</small><br>
                ${dyn ? `<small>Level: ${dyn.waterLevel}m</small><br><small>Status: ${dyn.status}</small><br>` : ''}
                <div style="margin-top:10px;display:flex;gap:6px;">
                    <button onclick="App.showDeviceDetails('${device.id}')" style="flex:1;padding:6px;background:#1a73e8;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">Details</button>
                    <button onclick="App.editDevice('${device.id}')" style="flex:1;padding:6px;background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">Edit</button>
                    <button onclick="App.deleteDevice('${device.id}')" style="flex:1;padding:6px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">Delete</button>
                </div></div>`;
    },

    createGateWallPopup(gw) {
        const dyn = GateWallDynamicManager.getCurrent(gw.id);
        return `<div style="min-width:220px;"><b>${gw.name}</b><br><small>Type: ${gw.type.toUpperCase()}</small><br>
                ${dyn ? `<small>Flow: ${dyn.flowDirection}</small><br><small>Status: ${dyn.status}</small><br><small>Battery: ${dyn.batteryLevel}%</small><br>` : ''}
                <div style="margin-top:10px;display:flex;gap:6px;">
                    <button onclick="App.showGateWallDetails('${gw.id}')" style="flex:1;padding:6px;background:#9C27B0;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">Control</button>
                    <button onclick="App.deleteGateWall('${gw.id}')" style="flex:1;padding:6px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">Delete</button>
                </div></div>`;
    },

    createPipelinePopup(pipeline, dyn) {
        const flowInfo = dyn?.flowSegments ? `${dyn.flowSegments.filter(s => s.hasFlow).length} of ${dyn.flowSegments.length} segments flowing` : 'No flow data';
        return `<div style="min-width:220px;"><b>${pipeline.name}</b><br>
                ${dyn ? `<small>Overall: ${dyn.flowActive?'<span style="color:#2196F3;">‚úì Active</span>':'<span style="color:#F44336;">‚úó Inactive</span>'}</small><br>
                <small>Segments: ${flowInfo}</small><br><small>Flow Rate: ${dyn.flowRate} L/min</small><br><small>Pressure: ${dyn.pressure} PSI</small><br>` : ''}
                <div style="margin-top:8px;display:flex;gap:6px;">
                    <button onclick="App.showPipelineDetails('${pipeline.id}')" style="flex:1;padding:6px;background:#FF5722;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">Details</button>
                    <button onclick="App.deletePipeline('${pipeline.id}')" style="flex:1;padding:6px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">Delete</button>
                </div></div>`;
    },

    showPipelineDetails(id) {
        const pipe = PipelineStaticManager.getById(id), dyn = PipelineDynamicManager.getCurrent(id);
        if(!pipe) return;
        
        const segs = dyn?.flowSegments ? dyn.flowSegments.map((s, i) => `
            <div class="flow-segment ${s.hasFlow?'flowing':'blocked'}">
                <b>Segment ${i + 1}</b><br><small>Position: ${(s.start*100).toFixed(0)}% - ${(s.end*100).toFixed(0)}%</small><br>
                <small>Status: ${s.hasFlow ? '<span style="color:#2196F3;">üíß Flowing</span>' : '<span style="color:#F44336;">üö´ Blocked</span>'}</small>
            </div>`).join('') : '<p style="text-align:center;color:#999;">No segment data</p>';

        document.getElementById('panelHeader').classList.remove('gatewall');
        document.getElementById('panelHeader').classList.add('pipeline');
        document.getElementById('panelTitle').textContent = pipe.name;
        document.getElementById('panelContent').innerHTML = `
            <div class="panel-section"><div class="section-header"><h3>üö∞ Pipeline Information</h3></div>
                <div class="detail-row"><span class="detail-label">Pipeline ID:</span><span class="detail-value">${pipe.id}</span></div>
                <div class="detail-row"><span class="detail-label">Length:</span><span class="detail-value">${pipe.length || 'N/A'} m</span></div>
                <div class="detail-row"><span class="detail-label">Material:</span><span class="detail-value">${pipe.material || 'PVC'}</span></div>
                <div class="detail-row"><span class="detail-label">Diameter:</span><span class="detail-value">${pipe.diameter || '100'} mm</span></div>
            </div>
            <div class="panel-section"><div class="section-header"><h3>üíß Flow Status</h3></div>
                ${dyn ? `<div class="detail-row"><span class="detail-label">Overall Status:</span><span class="status-badge ${dyn.flowActive?'status-active':'status-inactive'}">${dyn.flowActive?'Active':'Inactive'}</span></div>
                <div class="detail-row"><span class="detail-label">Flow Rate:</span><span class="detail-value">${dyn.flowRate} L/min</span></div>
                <div class="detail-row"><span class="detail-label">Pressure:</span><span class="detail-value">${dyn.pressure} PSI</span></div>
                <div class="detail-row"><span class="detail-label">Flow Ratio:</span><span class="detail-value">${(dyn.flowRatio*100).toFixed(0)}%</span></div>` : '<p style="text-align:center;color:#999;">No flow data</p>'}
            </div>
            <div class="panel-section"><div class="section-header"><h3>üìä Flow Segments</h3></div>${segs}</div>
            <div class="panel-section"><div class="section-header"><h3>üîó Connections</h3></div>
                <div class="detail-row"><span class="detail-label">Gate Walls:</span><span class="detail-value">${(pipe.connectedGateWalls||[]).length}</span></div>
                <div class="detail-row"><span class="detail-label">Devices:</span><span class="detail-value">${(pipe.connectedDevices||[]).length}</span></div>
            </div>`;
        document.getElementById('detailsPanel').classList.add('active');
    },

    showDeviceDetails(id) {
        const dev = TankStaticManager.getById(id);
        if(!dev) return;
        this.currentDevice = id;
        const dyn = TankDynamicManager.getCurrent(id);

        document.getElementById('panelHeader').classList.remove('gatewall', 'pipeline');
        document.getElementById('panelTitle').textContent = dev.name;
        document.getElementById('panelContent').innerHTML = `
            <div class="panel-section"><div class="section-header"><h3>üìã Device Information</h3>
                <button onclick="App.editDevice('${dev.id}')" class="btn btn-success" style="width:auto;padding:6px 12px;margin:0;">Edit</button></div>
                <div class="detail-row"><span class="detail-label">Device ID:</span><span class="detail-value">${dev.id}</span></div>
                <div class="detail-row"><span class="detail-label">Type:</span><span class="detail-value">${dev.type.toUpperCase()}</span></div>
                <div class="detail-row"><span class="detail-label">Capacity:</span><span class="detail-value">${dev.capacity} L</span></div>
            </div>
            <div class="panel-section"><div class="section-header"><h3>üìä Live Data</h3></div>
                ${dyn ? `<div class="detail-row"><span class="detail-label">Water Level:</span><span class="detail-value">${dyn.waterLevel} m</span></div>
                <div class="detail-row"><span class="detail-label">Pressure:</span><span class="detail-value">${dyn.pressure} PSI</span></div>
                <div class="detail-row"><span class="detail-label">Flow Rate:</span><span class="detail-value">${dyn.flowRate} L/min</span></div>
                <div class="detail-row"><span class="detail-label">pH Level:</span><span class="detail-value">${dyn.phLevel}</span></div>
                <div class="detail-row"><span class="detail-label">Temperature:</span><span class="detail-value">${dyn.temperature} ¬∞C</span></div>
                <div class="detail-row"><span class="detail-label">Status:</span><span class="status-badge ${dyn.status==='active'?'status-active':'status-inactive'}">${dyn.status}</span></div>` : '<p style="text-align:center;color:#999;">No live data</p>'}
            </div>
            <div class="panel-section"><div class="section-header"><h3>üìç Location</h3>
                <button onclick="App.flyToDevice('${dev.id}')" class="btn btn-primary" style="width:auto;padding:6px 12px;margin:0;font-size:11px;">üó∫Ô∏è Go to Location</button></div>
                <div class="detail-row"><span class="detail-label">State:</span><span class="detail-value">${dev.state||'N/A'}</span></div>
                <div class="detail-row"><span class="detail-label">District:</span><span class="detail-value">${dev.district||'N/A'}</span></div>
                <div class="detail-row"><span class="detail-label">Mandal:</span><span class="detail-value">${dev.mandal||'N/A'}</span></div>
                <div class="detail-row"><span class="detail-label">Habitation:</span><span class="detail-value">${dev.habitation||'N/A'}</span></div>
                <div class="detail-row"><span class="detail-label">Coordinates:</span><span class="detail-value">${dev.latitude.toFixed(6)}, ${dev.longitude.toFixed(6)}</span></div>
            </div>
            <div class="panel-section"><div class="section-header"><h3>üìú History</h3></div>
                <p style="font-size:11px;color:#666;margin-bottom:10px;">Recorded every 5 minutes (${TankDynamicManager.getHistory(id).length} records)</p>
                <button onclick="App.showFullHistory('${dev.id}')" class="btn btn-primary">üìä View Full History</button>
            </div>`;
        document.getElementById('detailsPanel').classList.add('active');
        this.map.flyTo([dev.latitude, dev.longitude], 16, {animate: true, duration: 1.5});
    },

    flyToDevice(id) {
        const dev = TankStaticManager.getById(id);
        if(!dev) return;
        this.map.flyTo([dev.latitude, dev.longitude], 18, {animate: true, duration: 1.5});
        if(this.markers[id]) this.markers[id].openPopup();
        this.showNotification(`üìç Viewing ${dev.name}`, 'info');
    },

    showGateWallDetails(id) {
        const gw = GateWallStaticManager.getById(id);
        if(!gw) return;
        const dyn = GateWallDynamicManager.getCurrent(id);

        document.getElementById('panelHeader').classList.remove('pipeline');
        document.getElementById('panelHeader').classList.add('gatewall');
        document.getElementById('panelTitle').textContent = gw.name;
        document.getElementById('panelContent').innerHTML = `
            <div class="panel-section"><div class="section-header"><h3>üöß Gate Wall Info</h3></div>
                <div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value">${gw.id}</span></div>
                <div class="detail-row"><span class="detail-label">Type:</span><span class="detail-value">${gw.type.toUpperCase()}</span></div>
                ${dyn ? `<div class="detail-row"><span class="detail-label">Flow Direction:</span><span class="detail-value">${dyn.flowDirection}</span></div>
                <div class="detail-row"><span class="detail-label">Valve State:</span><span class="detail-value">${dyn.valveState}</span></div>
                <div class="detail-row"><span class="detail-label">Battery:</span><span class="detail-value">${dyn.batteryLevel}%</span></div>
                <div class="detail-row"><span class="detail-label">Pressure:</span><span class="detail-value">${dyn.pressure} PSI</span></div>
                <div class="detail-row"><span class="detail-label">Status:</span><span class="status-badge ${dyn.status==='active'?'status-active':'status-inactive'}">${dyn.status}</span></div>` : ''}
            </div>
            <div class="panel-section"><div class="section-header"><h3>üéÆ Flow Control</h3></div>
                <div class="flow-controls">${this.getFlowControlsHTML(gw, dyn)}</div>
                <div class="info-text" style="margin-top:10px;">üíß Blue pipelines = Water flowing<br>üî¥ Red pipelines = No flow</div>
            </div>
            <div class="panel-section"><div class="section-header"><h3>üìç Location</h3></div>
                <div class="detail-row"><span class="detail-label">Habitation:</span><span class="detail-value">${gw.habitation||'N/A'}</span></div>
                <div class="detail-row"><span class="detail-label">Mandal:</span><span class="detail-value">${gw.mandal||'N/A'}</span></div>
            </div>`;
        document.getElementById('detailsPanel').classList.add('active');
    },

    getFlowControlsHTML(gw, dyn) {
        const flow = dyn?.flowDirection || 'none';
        if(gw.type === 'straight') {
            return `<button class="flow-btn ${flow==='straight'?'active':''}" onclick="App.setFlowDirection('${gw.id}','straight')">‚û°Ô∏è Flow On</button>
                    <button class="flow-btn ${flow==='none'?'active':''}" onclick="App.setFlowDirection('${gw.id}','none')">‚õî Stop Flow</button>`;
        }
        return `<button class="flow-btn ${flow==='left'?'active':''}" onclick="App.setFlowDirection('${gw.id}','left')">‚¨ÖÔ∏è Flow Left</button>
                <button class="flow-btn ${flow==='right'?'active':''}" onclick="App.setFlowDirection('${gw.id}','right')">‚û°Ô∏è Flow Right</button>
                <button class="flow-btn ${flow==='straight'?'active':''}" onclick="App.setFlowDirection('${gw.id}','straight')">‚¨ÜÔ∏è Flow Straight</button>
                <button class="flow-btn ${flow==='none'?'active':''}" onclick="App.setFlowDirection('${gw.id}','none')">‚õî Stop All</button>`;
    },

    setFlowDirection(id, dir) {
        const gw = GateWallStaticManager.getById(id);
        if(!gw) return;
        GateWallDynamicManager.update(id, {
            id, timestamp: new Date().toISOString(), flowDirection: dir,
            valveState: dir==='none'?'closed':'open', pressure: dir==='none'?0:(10+Math.random()*40).toFixed(1),
            flowRate: dir==='none'?0:(Math.random()*150).toFixed(1), batteryLevel: 75+Math.random()*25,
            signalStrength: 60+Math.random()*40, temperature: (25+Math.random()*5).toFixed(1),
            mode: 'manual', status: dir==='none'?'inactive':'active', lastCommand: dir
        });
        this.updateAllPipelineFlow();
        this.showNotification(`Gate ${gw.name}: ${dir==='none'?'üî¥ CLOSED':'üîµ OPEN'}`, 'success');
        this.showGateWallDetails(id);
    },

    updateAllPipelineFlow() {
        const pipes = PipelineStaticManager.getAll(), gates = GateWallStaticManager.getAll();
        PipelineDynamicManager.updateAllPipelines(pipes, gates);
        pipes.forEach(p => this.renderPipelineSegments(p, PipelineDynamicManager.getCurrent(p.id)));
    },

    showFullHistory(id) {
        const dev = TankStaticManager.getById(id);
        if(!dev) return;
        const hist = TankDynamicManager.getHistory(id);
        this.historyData = hist;
        document.getElementById('historyModalTitle').textContent = `üìä ${dev.name} - History`;
        document.getElementById('historyStartDate').value = '';
        document.getElementById('historyEndDate').value = new Date().toISOString().split('T')[0];
        this.renderHistoryTable(hist);
        this.openModal('historyModal');
    },

    renderHistoryTable(data) {
        document.getElementById('historyTableBody').innerHTML = data.map(r => `
            <tr><td>${new Date(r.timestamp).toLocaleString()}</td><td>${r.waterLevel} m</td><td>${r.pressure} PSI</td>
            <td>${r.flowRate} L/min</td><td>${r.phLevel}</td><td>${r.temperature} ¬∞C</td>
            <td><span class="status-badge ${r.status==='active'?'status-active':'status-inactive'}">${r.status}</span></td></tr>`).join('');
    },

    onMapClick(e) {
        if(this.drawingMode) {
            const now = Date.now();
            if(now - this.lastClickTime < 300) this.finishPipeline();
            else { this.currentPipeline.push([e.latlng.lat, e.latlng.lng]); this.updateTempPipeline(); }
            this.lastClickTime = now;
        }
    },

    onMapRightClick(e) {
        if(this.drawingMode) return;
        ['deviceLat', 'deviceLng', 'gwLat', 'gwLng'].forEach(id => 
            document.getElementById(id).value = e.latlng[id.includes('Lat')?'lat':'lng'].toFixed(6));
    },

    updateTempPipeline() {
        if(this.tempPolyline) this.map.removeLayer(this.tempPolyline);
        if(this.currentPipeline.length > 0) 
            this.tempPolyline = L.polyline(this.currentPipeline, {color: '#FF5722', weight: 4, opacity: 0.7, dashArray: '10, 10'}).addTo(this.map);
    },

    finishPipeline() {
        if(this.currentPipeline.length < 2) { this.showNotification('Pipeline needs at least 2 points', 'warning'); return; }
        const pipe = {
            id: 'pipe_'+Date.now(), name: 'Pipeline '+Date.now(), points: this.currentPipeline,
            connectedGateWalls: this.findNearbyGateWalls(this.currentPipeline),
            connectedDevices: this.findNearbyDevices(this.currentPipeline),
            material: 'PVC', diameter: 100, length: this.calculateLength(this.currentPipeline),
            createdAt: new Date().toISOString(), updatedAt: new Date().toISOString()
        };
        PipelineStaticManager.create(pipe);
        PipelineDynamicManager.register(pipe.id);
        PipelineDynamicManager.update(pipe.id, null, pipe, GateWallStaticManager.getAll());
        this.addPipelinePolyline(pipe);
        if(this.tempPolyline) { this.map.removeLayer(this.tempPolyline); this.tempPolyline = null; }
        this.currentPipeline = []; this.drawingMode = false; this.map.dragging.enable();
        document.getElementById('drawingIndicator').classList.remove('active');
        document.getElementById('drawPipelineBtn').textContent = 'üé® Start Drawing Pipeline';
        document.getElementById('drawPipelineBtn').classList.replace('btn-danger', 'btn-success');
        this.showNotification(`Pipeline created! Connected: ${pipe.connectedGateWalls.length} gates, ${pipe.connectedDevices.length} devices`, 'success');
    },

    findNearbyGateWalls(pts) {
        const nearby = [], thresh = 0.005;
        GateWallStaticManager.getAll().forEach(gw => {
            pts.forEach(pt => {
                const dist = Math.sqrt(Math.pow(gw.latitude - pt[0], 2) + Math.pow(gw.longitude - pt[1], 2));
                if(dist < thresh && !nearby.includes(gw.id)) nearby.push(gw.id);
            });
        });
        return nearby;
    },

    findNearbyDevices(pts) {
        const nearby = [], thresh = 0.005;
        TankStaticManager.getAll().forEach(d => {
            pts.forEach(pt => {
                const dist = Math.sqrt(Math.pow(d.latitude - pt[0], 2) + Math.pow(d.longitude - pt[1], 2));
                if(dist < thresh && !nearby.includes(d.id)) nearby.push(d.id);
            });
        });
        return nearby;
    },

    calculateLength(pts) {
        let len = 0;
        for(let i = 1; i < pts.length; i++) 
            len += Math.sqrt(Math.pow(pts[i][0]-pts[i-1][0], 2) + Math.pow(pts[i][1]-pts[i-1][1], 2)) * 111000;
        return Math.round(len);
    },

    buildHierarchy() {
        this.hierarchy = {};
        [...TankStaticManager.getAll(), ...GateWallStaticManager.getAll()].forEach(d => {
            const [c, s, di, m, h] = [d.country||'India', d.state||'Unassigned', d.district||'Unassigned', 
                                       d.mandal||'Unassigned', d.habitation||'Unassigned'];
            if(!this.hierarchy[c]) this.hierarchy[c] = {};
            if(!this.hierarchy[c][s]) this.hierarchy[c][s] = {};
            if(!this.hierarchy[c][s][di]) this.hierarchy[c][s][di] = {};
            if(!this.hierarchy[c][s][di][m]) this.hierarchy[c][s][di][m] = {};
            if(!this.hierarchy[c][s][di][m][h]) this.hierarchy[c][s][di][m][h] = [];
            this.hierarchy[c][s][di][m][h].push(d);
        });
        this.populateCountryDropdown();
    },

    populateCountryDropdown() {
        document.getElementById('searchCountry').innerHTML = '<option value="">Select Country</option>' + 
            Object.keys(this.hierarchy).map(c => `<option value="${c}">${c}</option>`).join('');
    },

    onHierarchyChange(level, val) {
        const [c, s, di, m] = ['searchCountry', 'searchState', 'searchDistrict', 'searchMandal'].map(id => 
            document.getElementById(id).value);
        
        if(level === 'country' && val) {
            document.getElementById('searchState').innerHTML = '<option value="">Select State</option>' + 
                Object.keys(this.hierarchy[val]).map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('searchState').disabled = false;
            this.resetDropdowns(['searchDistrict','searchMandal','searchHabitation']);
        }
        if(level === 'state' && c && val) {
            document.getElementById('searchDistrict').innerHTML = '<option value="">Select District</option>' + 
                Object.keys(this.hierarchy[c][val]).map(d => `<option value="${d}">${d}</option>`).join('');
            document.getElementById('searchDistrict').disabled = false;
            this.resetDropdowns(['searchMandal','searchHabitation']);
        }
        if(level === 'district' && c && s && val) {
            document.getElementById('searchMandal').innerHTML = '<option value="">Select Mandal</option>' + 
                Object.keys(this.hierarchy[c][s][val]).map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('searchMandal').disabled = false;
            this.resetDropdowns(['searchHabitation']);
        }
        if(level === 'mandal' && c && s && di && val) {
            document.getElementById('searchHabitation').innerHTML = '<option value="">Select Habitation</option>' + 
                Object.keys(this.hierarchy[c][s][di][val]).map(h => `<option value="${h}">${h}</option>`).join('');
            document.getElementById('searchHabitation').disabled = false;
        }
        if(level === 'habitation' && c && s && di && m && val) 
            this.displayHierarchyResults(this.hierarchy[c][s][di][m][val]);
    },

    displayHierarchyResults(devs) {
        if(!devs?.length) { document.getElementById('hierarchyResults').style.display = 'none'; return; }
        document.getElementById('hierarchyResultsList').innerHTML = devs.map(d => {
            const type = d.type || 'gatewall', typeClass = {ohsr:'type-ohsr',gateway:'type-gateway'}[type] || 'type-gatewall';
            const fn = type==='ohsr'||type==='gateway'?'showDeviceDetails':'showGateWallDetails';
            return `<div class="result-item" onclick="App.${fn}('${d.id}')">
                <span class="item-type ${typeClass}">${type.toUpperCase()}</span><b>${d.name}</b><br><small>${d.id}</small></div>`;
        }).join('');
        document.getElementById('hierarchyResults').style.display = 'block';
    },

    onQuickSearch(q) {
        if(q.length < 2) { document.getElementById('quickResults').style.display = 'none'; return; }
        const results = [], ql = q.toLowerCase();
        TankStaticManager.getAll().forEach(d => {
            if(d.name.toLowerCase().includes(ql) || d.id.toLowerCase().includes(ql)) 
                results.push({...d, searchType: 'device'});
        });
        GateWallStaticManager.getAll().forEach(gw => {
            if(gw.name.toLowerCase().includes(ql) || gw.id.toLowerCase().includes(ql)) 
                results.push({...gw, searchType: 'gatewall'});
        });
        PipelineStaticManager.getAll().forEach(p => {
            if(p.name.toLowerCase().includes(ql) || p.id.toLowerCase().includes(ql)) 
                results.push({...p, searchType: 'pipeline'});
        });
        this.displayQuickResults(results);
    },

    displayQuickResults(results) {
        if(!results.length) { document.getElementById('quickResults').style.display = 'none'; return; }
        document.getElementById('quickResultsList').innerHTML = results.map(item => {
            const typeClass = {ohsr:'type-ohsr',gateway:'type-gateway',gatewall:'type-gatewall',pipeline:'type-pipeline'}[item.type||item.searchType];
            const fn = item.searchType==='device'?'showDeviceDetails':item.searchType==='gatewall'?'showGateWallDetails':'showPipelineDetails';
            return `<div class="result-item" onclick="App.${fn}('${item.id}')">
                <span class="item-type ${typeClass}">${(item.type||item.searchType).toUpperCase()}</span>
                <b>${item.name}</b><br><small>${item.habitation||item.mandal||'N/A'}</small></div>`;
        }).join('');
        document.getElementById('quickResults').style.display = 'block';
    },

    updateDatalistSuggestions() {
        const [states, districts, mandals, habitations] = [new Set(), new Set(), new Set(), new Set()];
        [...TankStaticManager.getAll(), ...GateWallStaticManager.getAll()].forEach(d => {
            if(d.state) states.add(d.state);
            if(d.district) districts.add(d.district);
            if(d.mandal) mandals.add(d.mandal);
            if(d.habitation) habitations.add(d.habitation);
        });
        document.getElementById('statesList').innerHTML = Array.from(states).map(s => `<option value="${s}">`).join('');
        document.getElementById('districtsList').innerHTML = Array.from(districts).map(d => `<option value="${d}">`).join('');
        document.getElementById('mandalsList').innerHTML = Array.from(mandals).map(m => `<option value="${m}">`).join('');
        document.getElementById('habitationsList').innerHTML = Array.from(habitations).map(h => `<option value="${h}">`).join('');
    },

    resetDropdowns(ids) {
        ids.forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">Select...</option>';
            el.disabled = true;
        });
        document.getElementById('hierarchyResults').style.display = 'none';
    },

    editDevice(id) {
        const dev = TankStaticManager.getById(id);
        if(!dev) return;
        this.editingDevice = id;
        ['deviceName','deviceType','deviceCountry','deviceState','deviceDistrict','deviceMandal',
         'deviceHabitation','deviceLat','deviceLng','deviceCapacity'].forEach((field, i) => {
            document.getElementById(field).value = [dev.name, dev.type, dev.country, dev.state||'', 
                dev.district||'', dev.mandal||'', dev.habitation||'', dev.latitude, dev.longitude, dev.capacity][i];
        });
        this.openModal('deviceModal');
        this.closeDetailsPanel();
        this.showNotification('Editing device - modify and click Add to save', 'info');
    },

    deleteDevice(id) {
        if(!confirm('Delete this device?')) return;
        if(this.markers[id]) { this.map.removeLayer(this.markers[id]); delete this.markers[id]; }
        TankStaticManager.remove(id);
        this.buildHierarchy();
        this.showNotification('Device deleted', 'info');
        this.closeDetailsPanel();
    },

    deleteGateWall(id) {
        if(!confirm('Delete this gate wall?')) return;
        if(this.markers[id]) { this.map.removeLayer(this.markers[id]); delete this.markers[id]; }
        GateWallStaticManager.remove(id);
        this.updateAllPipelineFlow();
        this.buildHierarchy();
        this.showNotification('Gate wall deleted', 'info');
        this.closeDetailsPanel();
    },

    deletePipeline(id) {
        if(!confirm('Delete this pipeline?')) return;
        if(this.polylines[id]) { this.polylines[id].forEach(p => this.map.removeLayer(p)); delete this.polylines[id]; }
        PipelineStaticManager.remove(id);
        this.showNotification('Pipeline deleted', 'info');
    },

    startSimulation() {
        setInterval(() => {
            TankStaticManager.getAll().forEach(d => {
                TankDynamicManager.updateTankData(d.id);
                if(this.markers[d.id]) 
                    this.markers[d.id].setPopupContent(this.createDevicePopup(d));
            });
            GateWallStaticManager.getAll().forEach(gw => {
                const dyn = GateWallDynamicManager.getCurrent(gw.id);
                if(dyn) { dyn.batteryLevel = Math.max(0, dyn.batteryLevel - 0.1); GateWallDynamicManager.update(gw.id, dyn); }
                if(this.markers[gw.id]) this.markers[gw.id].setPopupContent(this.createGateWallPopup(gw));
            });
        }, 5000);
    },

    openModal(id) {
        document.getElementById(id).classList.add('active');
        if(id === 'deviceModal') this.updateDeviceList();
        else if(id === 'gateWallModal') this.updateGateWallList();
    },

    closeModal(id) { document.getElementById(id).classList.remove('active'); },
    togglePanel(id) {
        const panel = document.getElementById(id);
        ['hierarchyPanel', 'quickSearchPanel', 'locationSearchPanel'].filter(p => p !== id)
            .forEach(p => document.getElementById(p).style.display = 'none');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    },
    closeDetailsPanel() { document.getElementById('detailsPanel').classList.remove('active'); },

    updateDeviceList() {
        const devs = TankStaticManager.getAll();
        document.getElementById('deviceListContainer').innerHTML = devs.length ? devs.map(d => `
            <div class="result-item" onclick="App.showDeviceDetails('${d.id}')">
                <span class="item-type type-${d.type}">${d.type.toUpperCase()}</span><b>${d.name}</b><br>
                <small>${d.id} ‚Ä¢ ${d.habitation||d.mandal||'N/A'}</small></div>`).join('') : 
            '<div style="text-align:center;padding:20px;color:#999;">No devices added yet</div>';
    },

    updateGateWallList() {
        const gates = GateWallStaticManager.getAll();
        document.getElementById('gateWallListContainer').innerHTML = gates.length ? gates.map(gw => `
            <div class="result-item" onclick="App.showGateWallDetails('${gw.id}')">
                <span class="item-type type-gatewall">${gw.type.toUpperCase()}</span><b>${gw.name}</b><br>
                <small>${gw.id} ‚Ä¢ ${gw.habitation||gw.mandal||'N/A'}</small></div>`).join('') : 
            '<div style="text-align:center;padding:20px;color:#999;">No gate walls added yet</div>';
    },

    showNotification(msg, type = 'info') {
        const n = document.createElement('div');
        n.className = `notification ${type}`;
        n.textContent = msg;
        document.body.appendChild(n);
        setTimeout(() => { n.style.animation = 'slideOut 0.3s ease'; setTimeout(() => n.remove(), 300); }, 3000);
    }
};

// UI Functions
const changeMapLayer = type => {
    if(App.currentLayer) App.map.removeLayer(App.currentLayer);
    App.currentLayer = App.layers[type].addTo(App.map);
    document.querySelectorAll('.map-controls button').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + type).classList.add('active');
};

const addDevice = () => {
    const fields = ['Name','Type','Country','State','District','Mandal','Habitation','Lat','Lng','Capacity']
        .map(f => document.getElementById('device'+f).value);
    const [name, type, country, state, district, mandal, habitation, lat, lng, capacity] = 
        [fields[0].trim(), fields[1], fields[2], fields[3].trim(), fields[4].trim(), 
         fields[5].trim(), fields[6].trim(), parseFloat(fields[7]), parseFloat(fields[8]), parseFloat(fields[9])||1000];
    
    if(!name || !lat || !lng) { App.showNotification('Please fill required fields', 'error'); return; }
    
    let dev;
    if(App.editingDevice) {
        TankStaticManager.update(App.editingDevice, {name, type, country, state, district, mandal, habitation, latitude: lat, longitude: lng, capacity});
        dev = TankStaticManager.getById(App.editingDevice);
        if(App.markers[App.editingDevice]) App.map.removeLayer(App.markers[App.editingDevice]);
        App.addDeviceMarker(dev);
        App.showNotification('Device updated!', 'success');
        App.editingDevice = null;
    } else {
        dev = TankStaticManager.create({id: type+'_'+Date.now(), name, type, country, state, district, mandal, 
            habitation, latitude: lat, longitude: lng, capacity, altitude: 0});
        TankDynamicManager.registerTank(dev.id);
        TankDynamicManager.updateTankData(dev.id);
        App.addDeviceMarker(dev);
        App.showNotification('Device added!', 'success');
    }
    ['deviceName','deviceLat','deviceLng','deviceCapacity'].forEach(id => document.getElementById(id).value = '');
    App.buildHierarchy();
    App.updateDatalistSuggestions();
    const connPipes = PipelineStaticManager.getAll().filter(p => p.connectedDevices?.includes(dev.id));
    if(connPipes.length) { App.updateAllPipelineFlow(); App.showNotification('Connected pipelines updated', 'info'); }
};

const addGateWall = () => {
    const fields = ['Name','Type','Country','State','District','Mandal','Habitation','Lat','Lng']
        .map(f => document.getElementById('gw'+f).value);
    const [name, type, country, state, district, mandal, habitation, lat, lng] = 
        [fields[0].trim(), fields[1], fields[2], fields[3].trim(), fields[4].trim(), 
         fields[5].trim(), fields[6].trim(), parseFloat(fields[7]), parseFloat(fields[8])];
    
    if(!name || !lat || !lng) { App.showNotification('Please fill required fields', 'error'); return; }
    
    const gw = GateWallStaticManager.create({id: 'gw_'+Date.now(), name, type, country, state, district, 
        mandal, habitation, latitude: lat, longitude: lng, altitude: 0, firmwareVersion: 'v1.0.0', controllerId: ''});
    GateWallDynamicManager.register(gw.id);
    GateWallDynamicManager.update(gw.id, {id: gw.id, timestamp: new Date().toISOString(), flowDirection: 'straight',
        valveState: 'open', pressure: (10+Math.random()*40).toFixed(1), flowRate: (Math.random()*150).toFixed(1),
        batteryLevel: 85+Math.random()*15, signalStrength: 70+Math.random()*30, 
        temperature: (25+Math.random()*5).toFixed(1), mode: 'manual', status: 'active', lastCommand: 'straight'});
    App.addGateWallMarker(gw);
    App.showNotification('Gate wall added! (Default: OPEN)', 'success');
    ['gwName','gwLat','gwLng'].forEach(id => document.getElementById(id).value = '');
    App.buildHierarchy();
    App.updateDatalistSuggestions();
    App.showNotification('Draw a pipeline through this gate to control flow', 'info');
};

const toggleDrawPipeline = () => {
    if(App.drawingMode) App.finishPipeline();
    else {
        App.drawingMode = true; App.currentPipeline = []; App.map.dragging.disable();
        document.getElementById('drawingIndicator').classList.add('active');
        document.getElementById('drawPipelineBtn').textContent = '‚úì Finish Pipeline';
        document.getElementById('drawPipelineBtn').classList.replace('btn-success', 'btn-danger');
        App.showNotification('üé® Drawing Mode Active', 'info');
    }
};

const switchTab = (cat, tab) => {
    const mid = cat === 'device' ? 'deviceModal' : 'gateWallModal';
    document.querySelectorAll(`#${mid} .tab-btn`).forEach(b => b.classList.remove('active'));
    document.querySelectorAll(`#${mid} .tab-content`).forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(`${cat}-${tab}-tab`).classList.add('active');
};

const closeModal = id => App.closeModal(id);
const closeDetailsPanel = () => App.closeDetailsPanel();

const filterHistory = () => {
    const [start, end] = ['historyStartDate', 'historyEndDate'].map(id => document.getElementById(id).value);
    let filtered = App.historyData;
    if(start) filtered = filtered.filter(r => new Date(r.timestamp) >= new Date(start));
    if(end) filtered = filtered.filter(r => new Date(r.timestamp) <= new Date(end + 'T23:59:59'));
    App.renderHistoryTable(filtered);
};

const exportHistoryCSV = () => {
    const rows = [['Timestamp','Water Level (m)','Pressure (PSI)','Flow Rate (L/min)','pH Level','Temperature (¬∞C)','Status']];
    document.querySelectorAll('#historyTableBody tr').forEach(tr => {
        rows.push(Array.from(tr.querySelectorAll('td')).map(td => 
            td.querySelector('.status-badge')?.textContent || td.textContent.trim()));
    });
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv'}), url = URL.createObjectURL(blob), a = document.createElement('a');
    a.href = url; a.download = `history_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
    App.showNotification('History exported to CSV', 'success');
};

const exportAllData = () => {
    const data = {devices: TankStaticManager.getAll(), gateWalls: GateWallStaticManager.getAll(),
        pipelines: PipelineStaticManager.getAll(), timestamp: new Date().toISOString(), version: '1.0'};
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}), 
          url = URL.createObjectURL(blob), a = document.createElement('a');
    a.href = url; a.download = `iot-data-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
    App.showNotification('Data exported successfully!', 'success');
};

const importData = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            [TankStaticManager, GateWallStaticManager, PipelineStaticManager].forEach(m => m.clearAll());
            Object.keys(App.markers).forEach(id => App.map.removeLayer(App.markers[id]));
            Object.keys(App.polylines).forEach(id => {
                (Array.isArray(App.polylines[id]) ? App.polylines[id] : [App.polylines[id]])
                    .forEach(p => App.map.removeLayer(p));
            });
            App.markers = {}; App.polylines = {};
            if(data.devices) data.devices.forEach(d => {
                TankStaticManager.create(d); TankDynamicManager.registerTank(d.id); 
                TankDynamicManager.updateTankData(d.id); App.addDeviceMarker(d);
            });
            if(data.gateWalls) data.gateWalls.forEach(gw => {
                GateWallStaticManager.create(gw); GateWallDynamicManager.register(gw.id);
                GateWallDynamicManager.update(gw.id); App.addGateWallMarker(gw);
            });
            if(data.pipelines) data.pipelines.forEach(p => {
                PipelineStaticManager.create(p); PipelineDynamicManager.register(p.id); App.addPipelinePolyline(p);
            });
            App.buildHierarchy(); App.updateDatalistSuggestions(); App.updateAllPipelineFlow();
            App.showNotification('Data imported successfully!', 'success');
        } catch(err) { App.showNotification('Failed to import: ' + err.message, 'error'); }
    };
    reader.readAsText(file);
};

const generateDummyData = () => {
    if(!confirm('Generate dummy data?')) return;
    const [states, districts, mandals, habitations] = [
        ['Telangana', 'Andhra Pradesh', 'Karnataka'],
        ['Warangal', 'Karimnagar', 'Khammam'],
        ['Warangal Urban', 'Hanamkonda', 'Jangaon'],
        ['Hanamkonda', 'Kazipet', 'Elkathurthy']
    ], base = [17.385, 78.486];
    
    for(let i = 0; i < 10; i++) {
        const [lat, lng] = [base[0]+(Math.random()-0.5)*0.1, base[1]+(Math.random()-0.5)*0.1];
        const dev = TankStaticManager.create({id: 'tank_dummy_'+i, name: 'OHSR Tank '+(i+1),
            type: i%3===0?'gateway':'ohsr', country: 'India', state: states[i%3], district: districts[i%3],
            mandal: mandals[i%3], habitation: habitations[i%3], latitude: lat, longitude: lng,
            altitude: 100+Math.random()*50, capacity: 1000+Math.random()*2000});
        TankDynamicManager.registerTank(dev.id); TankDynamicManager.updateTankData(dev.id); App.addDeviceMarker(dev);
    }
    
    for(let i = 0; i < 5; i++) {
        const [lat, lng] = [base[0]+(Math.random()-0.5)*0.1, base[1]+(Math.random()-0.5)*0.1];
        const gw = GateWallStaticManager.create({id: 'gw_dummy_'+i, name: 'Gate Wall '+(i+1),
            type: i%2===0?'straight':'t-junction', country: 'India', state: states[i%3],
            district: districts[i%3], mandal: mandals[i%3], habitation: habitations[i%3],
            latitude: lat, longitude: lng, altitude: 100, firmwareVersion: 'v1.0.0', controllerId: 'CTRL'+i});
        GateWallDynamicManager.register(gw.id); GateWallDynamicManager.update(gw.id); App.addGateWallMarker(gw);
    }
    
    App.buildHierarchy(); App.updateDatalistSuggestions(); App.updateAllPipelineFlow();
    App.showNotification('Dummy data generated!', 'success');
};

// Location Search
let searchTimeout = null, searchCache = {};

const searchLocation = () => {
    const q = document.getElementById('locationSearchInput').value.trim();
    if(!q || q.length < 2) { document.getElementById('locationResults').style.display = 'none'; return; }
    
    document.getElementById('locationResultsList').innerHTML = '<div style="padding:10px;text-align:center;color:#666;">üîç Searching...</div>';
    document.getElementById('locationResults').style.display = 'block';
    
    if(searchCache[q]) { displayLocationResults(searchCache[q]); return; }
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=10&addressdetails=1&countrycodes=in&dedupe=1`, 
            {headers: {'User-Agent': 'IoT Water Management System'}})
        .then(r => r.json())
        .then(data => {
            if(data?.length) { searchCache[q] = data; displayLocationResults(data); }
            else document.getElementById('locationResultsList').innerHTML = 
                '<div style="padding:10px;text-align:center;color:#999;">No results found</div>';
        })
        .catch(() => document.getElementById('locationResultsList').innerHTML = 
            '<div style="padding:10px;text-align:center;color:#dc3545;">‚ö†Ô∏è Search failed</div>');
    }, 300);
};

const displayLocationResults = results => {
    document.getElementById('locationResultsList').innerHTML = results.slice(0, 10).map((r, i) => {
        const icon = {city:'üèôÔ∏è',town:'üèòÔ∏è',village:'üè°',state:'üó∫Ô∏è',building:'üè¢',water:'üíß',road:'üõ£Ô∏è'}[r.type||r.class] || 'üìç';
        const addr = r.address ? [r.address.village, r.address.town, r.address.city, 
            r.address.state_district, r.address.state].filter(Boolean).join(', ') || r.display_name : r.display_name;
        return `<div class="result-item" onclick="selectLocation(${r.lat}, ${r.lon}, '${r.display_name.replace(/'/g, "\\'")}', ${i})">
            <span style="font-size:18px;margin-right:8px;">${icon}</span><div style="flex:1;">
            <b>${r.name || addr.split(',')[0]}</b><br><small style="color:#666;">${addr}</small><br>
            <small style="color:#999;font-size:10px;">üìç ${parseFloat(r.lat).toFixed(6)}, ${parseFloat(r.lon).toFixed(6)}</small>
            </div></div>`;
    }).join('');
    document.getElementById('locationResults').style.display = 'block';
};

const selectLocation = (lat, lon, name) => {
    App.map.setView([lat, lon], App.map.getZoom(), {animate: true});
    if(App.tempLocationMarker) App.map.removeLayer(App.tempLocationMarker);
    App.tempLocationMarker = L.marker([lat, lon], {
        icon: L.divIcon({
            html: '<div style="background:#FF5722;width:50px;height:50px;border-radius:50%;border:4px solid white;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(0,0,0,0.5);font-size:25px;animation:pulse 2s infinite;">üìç</div>',
            iconSize: [50, 50]
        })
    }).addTo(App.map).bindPopup(`<b>Selected Location</b><br>${name}<br><br><button onclick="removeLocationMarker()" style="padding:5px 10px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;">Remove</button>`).openPopup();
    
    ['deviceLat', 'deviceLng', 'gwLat', 'gwLng'].forEach(id => 
        document.getElementById(id).value = (id.includes('Lat') ? lat : lon).toFixed(6));
    App.showNotification('Location selected! Coordinates auto-filled.', 'success');
};

const removeLocationMarker = () => {
    if(App.tempLocationMarker) { App.map.removeLayer(App.tempLocationMarker); App.tempLocationMarker = null; }
    App.showNotification('Location marker removed', 'info');
};

// Initialize live search
document.addEventListener('DOMContentLoaded', () => {
    const inp = document.getElementById('locationSearchInput');
    if(inp) {
        inp.addEventListener('input', searchLocation);
        inp.addEventListener('keydown', e => e.key === 'Enter' && searchLocation());
    }
});

// Initialize app
window.onload = () => App.init();
    </script>
</body>
</html>
